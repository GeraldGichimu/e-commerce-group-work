<?php 
include 'includes/header.php';
include 'includes/config.php';

$type = $_GET['type'] ?? '';
$id = $_GET['id'] ?? 0;

// Check if user is logged in
session_start();
if(!isset($_SESSION['user_id'])) {
    header("Location: login.php?redirect=book.php?type=$type&id=$id");
    exit();
}

// Fetch item details based on type and id
$item = [];
$item_type = '';

switch($type) {
    case 'flight':
        // In a real app, this would query the database
        $item = [
            'id' => $id,
            'airline' => 'Global Airlines',
            'flight_number' => 'GA123',
            'departure_city' => 'New York',
            'arrival_city' => 'London',
            'departure_date' => '2023-12-15 08:00',
            'arrival_date' => '2023-12-15 11:00',
            'price' => 299.99
        ];
        $item_type = 'Flight';
        break;
        
    case 'hotel':
        $item = [
            'id' => $id,
            'name' => 'Grand Hotel',
            'location' => 'Paris City Center',
            'check_in' => '2023-12-15',
            'check_out' => '2023-12-20',
            'price_per_night' => 150.00,
            'total_price' => 750.00
        ];
        $item_type = 'Hotel';
        break;
        
    case 'car':
        $item = [
            'id' => $id,
            'model' => 'Toyota Corolla',
            'pickup_date' => '2023-12-15',
            'dropoff_date' => '2023-12-20',
            'price_per_day' => 45.00,
            'total_price' => 225.00
        ];
        $item_type = 'Car Rental';
        break;
        
    case 'tour':
        $item = [
            'id' => $id,
            'title' => 'Paris City Highlights',
            'start_date' => '2023-12-15',
            'end_date' => '2023-12-18',
            'price' => 299.00
        ];
        $item_type = 'Tour';
        break;
        
    default:
        header("Location: index.php");
        exit();
}

// Process booking form submission
if($_SERVER['REQUEST_METHOD'] == 'POST') {
    $user_id = $_SESSION['user_id'];
    $booking_date = date('Y-m-d H:i:s');
    
    // Calculate total price
    $total_price = 0;
    if($type == 'hotel') {
        $check_in = $_POST['check_in'];
        $check_out = $_POST['check_out'];
        $nights = (strtotime($check_out) - strtotime($check_in)) / (60 * 60 * 24);
        $total_price = $nights * $item['price_per_night'];
    } elseif($type == 'car') {
        $pickup_date = $_POST['pickup_date'];
        $dropoff_date = $_POST['dropoff_date'];
        $days = (strtotime($dropoff_date) - strtotime($pickup_date)) / (60 * 60 * 24);
        $total_price = $days * $item['price_per_day'];
    } else {
        $total_price = $item['price'];
    }
    
    // Insert booking into database
    try {
        $stmt = $pdo->prepare("INSERT INTO bookings (user_id, booking_type, item_id, booking_date, check_in_date, check_out_date, total_price, status) 
                               VALUES (?, ?, ?, ?, ?, ?, ?, 'confirmed')");
        $stmt->execute([
            $user_id,
            $type,
            $id,
            $booking_date,
            $_POST['check_in'] ?? null,
            $_POST['check_out'] ?? null,
            $total_price
        ]);
        
        $booking_id = $pdo->lastInsertId();
        header("Location: booking-confirmation.php?id=$booking_id");
        exit();
    } catch (PDOException $e) {
        $error = "Error processing booking: " . $e->getMessage();
    }
}
?>

<div class="booking-page">
    <h2 class="mb-4">Book <?php echo $item_type; ?></h2>
    
    <?php if(isset($error)): ?>
        <div class="alert alert-danger"><?php echo $error; ?></div>
    <?php endif; ?>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Booking Details</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        <?php if($type == 'flight'): ?>
                            <div class="mb-3">
                                <h5><?php echo $item['airline']; ?> Flight <?php echo $item['flight_number']; ?></h5>
                                <p>
                                    <?php echo $item['departure_city']; ?> to <?php echo $item['arrival_city']; ?><br>
                                    Departure: <?php echo $item['departure_date']; ?><br>
                                    Arrival: <?php echo $item['arrival_date']; ?>
                                </p>
                                <p class="h4 text-primary">Price: $<?php echo number_format($item['price'], 2); ?></p>
                            </div>
                            
                            <div class="mb-3">
                                <label for="passenger_name" class="form-label">Passenger Name</label>
                                <input type="text" class="form-control" id="passenger_name" name="passenger_name" required>
                            </div>
                            
                        <?php elseif($type == 'hotel'): ?>
                            <div class="mb-3">
                                <h5><?php echo $item['name']; ?></h5>
                                <p><?php echo $item['location']; ?></p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="check_in" class="form-label">Check-in Date</label>
                                        <input type="date" class="form-control" id="check_in" name="check_in" 
                                               value="<?php echo $item['check_in']; ?>" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="check_out" class="form-label">Check-out Date</label>
                                        <input type="date" class="form-control" id="check_out" name="check_out" 
                                               value="<?php echo $item['check_out']; ?>" required>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label for="guests" class="form-label">Number of Guests</label>
                                    <select class="form-select" id="guests" name="guests">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                </div>
                                
                                <p class="h4 mt-3 text-primary">
                                    Price: $<?php echo number_format($item['price_per_night'], 2); ?> per night
                                </p>
                            </div>
                            
                        <?php elseif($type == 'car'): ?>
                            <div class="mb-3">
                                <h5><?php echo $item['model']; ?></h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="pickup_date" class="form-label">Pick-up Date</label>
                                        <input type="date" class="form-control" id="pickup_date" name="pickup_date" 
                                               value="<?php echo $item['pickup_date']; ?>" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dropoff_date" class="form-label">Drop-off Date</label>
                                        <input type="date" class="form-control" id="dropoff_date" name="dropoff_date" 
                                               value="<?php echo $item['dropoff_date']; ?>" required>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label for="driver_name" class="form-label">Driver's Name</label>
                                    <input type="text" class="form-control" id="driver_name" name="driver_name" required>
                                </div>
                                
                                <p class="h4 mt-3 text-primary">
                                    Price: $<?php echo number_format($item['price_per_day'], 2); ?> per day
                                </p>
                            </div>
                            
                        <?php elseif($type == 'tour'): ?>
                            <div class="mb-3">
                                <h5><?php echo $item['title']; ?></h5>
                                <p>
                                    Dates: <?php echo $item['start_date']; ?> to <?php echo $item['end_date']; ?>
                                </p>
                                
                                <div class="mt-3">
                                    <label for="participants" class="form-label">Number of Participants</label>
                                    <select class="form-select" id="participants" name="participants">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                </div>
                                
                                <p class="h4 mt-3 text-primary">Price: $<?php echo number_format($item['price'], 2); ?></p>
                            </div>
                        <?php endif; ?>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Confirm Booking</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>Booking Summary</h4>
                </div>
                <div class="card-body">
                    <?php if($type == 'flight'): ?>
                        <p><strong>Flight:</strong> <?php echo $item['airline']; ?> <?php echo $item['flight_number']; ?></p>
                        <p><strong>Route:</strong> <?php echo $item['departure_city']; ?> to <?php echo $item['arrival_city']; ?></p>
                        <p><strong>Departure:</strong> <?php echo $item['departure_date']; ?></p>
                        <p><strong>Price:</strong> $<?php echo number_format($item['price'], 2); ?></p>
                        
                    <?php elseif($type == 'hotel'): ?>
                        <p><strong>Hotel:</strong> <?php echo $item['name']; ?></p>
                        <p><strong>Location:</strong> <?php echo $item['location']; ?></p>
                        <p><strong>Check-in:</strong> <?php echo $item['check_in']; ?></p>
                        <p><strong>Check-out:</strong> <?php echo $item['check_out']; ?></p>
                        <p><strong>Price per night:</strong> $<?php echo number_format($item['price_per_night'], 2); ?></p>
                        <?php 
                            $nights = (strtotime($item['check_out']) - strtotime($item['check_in'])) / (60 * 60 * 24);
                            $total = $nights * $item['price_per_night'];
                        ?>
                        <p><strong>Total:</strong> $<?php echo number_format($total, 2); ?> (<?php echo $nights; ?> nights)</p>
                        
                    <?php elseif($type == 'car'): ?>
                        <p><strong>Car Model:</strong> <?php echo $item['model']; ?></p>
                        <p><strong>Pick-up:</strong> <?php echo $item['pickup_date']; ?></p>
                        <p><strong>Drop-off:</strong> <?php echo $item['dropoff_date']; ?></p>
                        <p><strong>Price per day:</strong> $<?php echo number_format($item['price_per_day'], 2); ?></p>
                        <?php 
                            $days = (strtotime($item['dropoff_date']) - strtotime($item['pickup_date'])) / (60 * 60 * 24);
                            $total = $days * $item['price_per_day'];
                        ?>
                        <p><strong>Total:</strong> $<?php echo number_format($total, 2); ?> (<?php echo $days; ?> days)</p>
                        
                    <?php elseif($type == 'tour'): ?>
                        <p><strong>Tour:</strong> <?php echo $item['title']; ?></p>
                        <p><strong>Dates:</strong> <?php echo $item['start_date']; ?> to <?php echo $item['end_date']; ?></p>
                        <p><strong>Price:</strong> $<?php echo number_format($item['price'], 2); ?></p>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</div>

<?php include 'includes/footer.php'; ?>
